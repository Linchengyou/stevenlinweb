{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
    <div class="col-md-4 col-md-offset-4">
        <H3><b>{{ _('Device Setting') }}</b></H3>
        <hr>
        {% if form %}
            <form class="form form-horizontal" method="post" role="form">
                {{ form.hidden_tag() }}{{ wtf.form_errors(form, hiddens="only") }}
                <div class="form-group">
                    {{ wtf.form_field(form.mode) }}
                    {{ wtf.form_field(form.target_ip) }}
                    {{ wtf.form_field(form.target_port) }}
                    {{ wtf.form_field(form.target_timeout) }}
                    <div id="data"></div>
                </div>
                <div class="text-danger" id="conn_status"></div>
                <br>
                <div class="form-row text-right">
                    <div class="col-12">
                        {{ form.submit(class_="btn btn-primary") }}
                    </div>
                </div>
            </form>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script type="text/javascript">
        $(function () {
            $('#server').addClass('active');
        });
        conn_status();
        function conn_status() {
            $.ajax({
                type: 'GET',
                url: '/get_conn_status',
                success: function (data) {
                    $("#conn_status").text(data);
                },
                error: function () {
                }
            });
        }
        setInterval("conn_status()", 1000);

        $('#mode').change(change_page);
        function change_page(){
            let mode = $('#mode').val();
            if (mode != 1){
                window.location.replace("{{ url_for('func.server_setting') }}" + "?mode=" + mode)
            }
        }
        let port_chk = true;
        $('#target_port').change(function () {
            let reg = /^([8-9][0-9]|[0-9]{3,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$/;
            let port = $('#target_port');
            if (!port.val().match(reg)){
                port.css("background-color",'#FF8888');
                alert("{{_("Port範圍:80~65535")}}");
                port_chk = false;
            }else{
                port.css("background-color",'transparent');
                port_chk = true;
            }
        });
        let ip_chk = true;
        $('#target_ip').change(function () {
            let reg = /^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))*$/;
            let port = $('#target_ip');
            if (!port.val().match(reg)){
                port.css("background-color",'#FF8888');
                alert("{{_("IP格式錯誤")}}");
                ip_chk = false;
            }else{
                port.css("background-color",'transparent');
                ip_chk = true;
            }
        });
        let timeout_chk = true;
        $('#target_timeout').change(function () {
            let reg = /^([0-9]|[1-5][0-9]|60)$/;
            let target_timeout = $('#target_timeout');
            if (!target_timeout.val().match(reg)) {
                target_timeout.css("background-color", '#FF8888');
                alert("{{_("範圍:0~3600")}}");
                timeout_chk = false;
            } else {
                target_timeout.css("background-color", 'transparent');
                timeout_chk = true;
            }
        });

        $('form').submit(function (){
            if (port_chk && ip_chk && timeout_chk) {
            } else {
                alert("{{_('Input error!')}}");
                return false;
            }
        });
    </script>
{% endblock %}